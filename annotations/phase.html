<!DOCTYPE html>  <html> <head>   <title>phase.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="ephemeris.html">                 ephemeris.coffee               </a>                                           <a class="source" href="phase.html">                 phase.coffee               </a>                                           <a class="source" href="points.html">                 points.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               phase.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">_       = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;underscore&quot;</span><span class="p">)</span>
<span class="nv">cliff   = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;cliff&quot;</span><span class="p">)</span>
<span class="nv">degrees = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;upon&quot;</span><span class="p">).</span><span class="nx">degrees</span>
<span class="nv">Ensemble = </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;archai&quot;</span><span class="p">).</span><span class="nx">Ensemble</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>This is just points presentation,
It could later be done with a <code>Backbone.View</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">module.exports = phase = </span><span class="nf">(streamin, stream) -&gt;</span>
  <span class="nx">streamin</span><span class="p">.</span><span class="kc">on</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="nf">(data) -&gt;</span>
    <span class="nv">json = </span><span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>It's just about output format from here on.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">json</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="nv">ensemble = </span><span class="k">new</span> <span class="nx">Ensemble</span>
      <span class="nv">longitude = </span><span class="s2">&quot;   longitude&quot;</span> <span class="c1"># the name cliff label</span>
      <span class="nv">rpad = </span><span class="s1">&#39; &#39;</span> <span class="c1"># right-padding for better readability</span>
      <span class="nv">table =</span>
        <span class="p">[</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot; &quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its, it) -&gt;</span>
            <span class="nv">lead = </span><span class="k">if</span> <span class="nx">its</span><span class="p">.</span><span class="nx">sid</span> <span class="o">&gt;=</span> <span class="mi">10000</span> <span class="k">then</span> <span class="s2">&quot;+&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="nx">it</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">)</span><span class="o">?</span> <span class="k">then</span> <span class="nx">it</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;u&#39;</span><span class="p">).</span><span class="nx">white</span> <span class="k">else</span> <span class="nx">lead</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;what&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its, it) -&gt;</span>
            <span class="k">if</span> <span class="nx">it</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="s1">&#39;?&#39;</span> <span class="k">then</span> <span class="nx">its</span><span class="p">.</span><span class="nx">id</span> <span class="k">else</span> <span class="nx">it</span><span class="p">.</span><span class="nx">get</span> <span class="s1">&#39;name&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="nx">longitude</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;lon&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="nx">degrees</span><span class="p">.</span><span class="nx">lon</span><span class="p">(</span><span class="nx">its</span><span class="p">.</span><span class="nx">lon</span><span class="p">).</span><span class="nx">rep</span><span class="p">(</span><span class="s1">&#39;str&#39;</span><span class="p">)</span>
          <span class="p">,</span> <span class="nv">sort: </span><span class="s2">&quot;lon&quot;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;~&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;day_lon&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="k">if</span> <span class="nx">its</span><span class="p">.</span><span class="nx">day_lon</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="s1">&#39;â„ž&#39;</span><span class="p">.</span><span class="nx">red</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot; speed&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;day_lon&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="k">if</span> <span class="nx">its</span><span class="p">.</span><span class="nx">day_lon</span><span class="o">?</span>
              <span class="nv">front = </span><span class="p">(</span><span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="nx">its</span><span class="p">.</span><span class="nx">day_lon</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="nx">its</span><span class="p">.</span><span class="nx">day_lon</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="s1">&#39; &#39;</span>
              <span class="nx">front</span> <span class="o">+</span> <span class="nx">its</span><span class="p">.</span><span class="nx">day_lon</span><span class="p">.</span><span class="nx">toFixed</span> <span class="mi">3</span>
            <span class="k">else</span> <span class="s1">&#39;&#39;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;  latitude&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;lat&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">false</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="nx">degrees</span><span class="p">.</span><span class="k">of</span><span class="p">(</span><span class="nx">its</span><span class="p">.</span><span class="nx">lat</span><span class="p">).</span><span class="nx">str</span><span class="p">()</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;distance&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;dau&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="k">return</span> <span class="s1">&#39;&#39;</span> <span class="nx">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isNumber</span> <span class="nx">its</span><span class="p">.</span><span class="nx">dau</span>
            <span class="nx">its</span><span class="p">.</span><span class="nx">dau</span><span class="p">.</span><span class="nx">toFixed</span><span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="nb">String</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span> <span class="nx">its</span><span class="p">.</span><span class="nx">dau</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; AU&quot;</span>
          <span class="p">}</span>
        <span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;key&quot;</span><span class="o">:</span> <span class="s2">&quot;reason&quot;</span>
          <span class="p">,</span> <span class="s2">&quot;req&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;re&quot;</span><span class="p">]</span>
          <span class="p">,</span> <span class="s2">&quot;act&quot;</span><span class="o">:</span> <span class="kc">true</span>
          <span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="o">:</span> <span class="nf">(its) -&gt;</span>
            <span class="nx">its</span><span class="p">.</span><span class="nx">re</span>
          <span class="p">}</span>
        <span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Reconsider what will be shown.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">show = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">table</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Don't show inactive stuff.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">continue</span> <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">act</span> <span class="o">isnt</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Don't work with columns all of whose values are entirely the same.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">continue</span> <span class="k">if</span> <span class="mi">1</span> <span class="o">is</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span> <span class="nx">_</span><span class="p">.</span><span class="nx">uniq</span> <span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span> <span class="nx">json</span><span class="p">,</span> <span class="nx">item</span><span class="p">.</span><span class="nx">req</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">show</span><span class="p">.</span><span class="nx">push</span> <span class="nx">item</span>
      <span class="nv">table = </span><span class="nx">show</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The out-values, titles and their color.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">out = </span><span class="p">[]</span>
      <span class="nv">titles = </span><span class="nx">_</span><span class="p">.</span><span class="nx">pluck</span> <span class="nx">table</span><span class="p">,</span> <span class="s1">&#39;key&#39;</span>
      <span class="nv">color = </span><span class="p">[]</span>
      <span class="nx">color</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;white&quot;</span> <span class="k">for</span> <span class="nx">count</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">table</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Add the representations for better readability.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">lon = </span><span class="nx">degrees</span><span class="p">.</span><span class="nx">lon</span> <span class="mi">0</span> <span class="c1"># just for representation symbols</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">11</span><span class="p">]</span>
        <span class="nx">json</span><span class="p">.</span><span class="nx">push</span>
          <span class="nv">marker: </span><span class="kc">true</span>
          <span class="nv">id: </span><span class="nx">lon</span><span class="p">.</span><span class="nx">representations</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
          <span class="nv">lon: </span><span class="nx">i</span> <span class="o">*</span> <span class="mi">30</span>
          <span class="nv">re: </span><span class="s2">&quot;zodiac&quot;</span><span class="p">.</span><span class="nx">green</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Process and sort.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">json</span>
        <span class="nx">out</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span> <span class="nv">order: </span><span class="p">[]</span> <span class="p">}</span>
        <span class="k">for</span> <span class="nx">col</span> <span class="k">in</span> <span class="nx">table</span>
          <span class="nv">it = </span><span class="nx">ensemble</span><span class="p">.</span><span class="nx">id</span> <span class="nx">item</span><span class="p">.</span><span class="nx">id</span>
          <span class="nv">piece = </span><span class="nx">col</span><span class="p">.</span><span class="nx">val</span> <span class="nx">item</span><span class="p">,</span> <span class="nx">it</span>
          <span class="nx">piece</span> <span class="o">+=</span> <span class="nx">rpad</span> <span class="k">if</span> <span class="nx">col</span><span class="p">.</span><span class="nx">key</span> <span class="o">isnt</span> <span class="s1">&#39;~&#39;</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">col</span><span class="p">.</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">piece</span>
          <span class="k">if</span> <span class="nx">col</span><span class="p">.</span><span class="nx">sort</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">item</span><span class="p">.</span><span class="nx">marker</span>
            <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">order</span><span class="p">.</span><span class="nx">push</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">item</span><span class="p">[</span><span class="nx">col</span><span class="p">.</span><span class="nx">sort</span><span class="p">])</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">id = </span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span> <span class="c1"># for post-processing</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Output markers for each representation.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">marker</span> <span class="o">is</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>TODO: append <code>" topical % fortune"</code> house numbers to <code>what</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">what = </span><span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;what&#39;</span><span class="p">]</span>
          <span class="nv">mark = </span><span class="s2">&quot;#{item.lon}\u00B0&quot;</span>
          <span class="nv">mark = </span><span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="nx">mark</span> <span class="k">for</span> <span class="nx">count</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">..(</span><span class="mi">5</span> <span class="o">-</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">length</span><span class="p">)]</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">marker = </span><span class="kc">true</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">order</span><span class="p">.</span><span class="nx">push</span> <span class="nb">Number</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">lon</span><span class="p">)</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="s1">&#39;what&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">what</span><span class="p">.</span><span class="nx">green</span>
          <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="nx">longitude</span><span class="p">]</span> <span class="o">=</span> <span class="nx">mark</span><span class="p">.</span><span class="nx">green</span>
      <span class="nv">out = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">out</span><span class="p">,</span> <span class="nf">(obj) -&gt;</span> <span class="nx">obj</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>TODO: an ugly hack - resolve this technical debt!
It all comes from lon 0 being 360.  Perhaps a 2nd
special kind of longitude should be further sub-classed?</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">idx</span> <span class="k">in</span> <span class="p">[(</span><span class="nx">out</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">)..</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nx">out</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="mi">360</span> <span class="k">then</span> <span class="nx">out</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">else</span> <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Sort again, because of the above...</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">out = </span><span class="nx">_</span><span class="p">.</span><span class="nx">sortBy</span> <span class="nx">out</span><span class="p">,</span> <span class="nf">(obj) -&gt;</span> <span class="nx">obj</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Reduce and write to the stream.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="p">[</span><span class="nx">seq</span><span class="p">,</span> <span class="nx">prev</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{},</span> <span class="p">{}]</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">item</span> <span class="k">of</span> <span class="nx">out</span>
        <span class="nx">out</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nv">extra = </span><span class="kc">false</span> <span class="c1"># innocent by default (i.e. not guilty)</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Instead of <code>if prev[longitude] isnt item[longitude]</code>.
Note: would be nice if we didn't hardcode <code>order[0]</code>
to be longitude for sure (technical debt).
It is used all over the place!</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">prev</span><span class="p">.</span><span class="nx">order</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">isnt</span> <span class="nx">item</span><span class="p">.</span><span class="nx">order</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
          <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">size</span><span class="p">(</span><span class="nx">seq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="nv">angled = topical = fortune = </span><span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>One or more of the angles can be found in this sequence.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">union</span> <span class="p">[</span><span class="s1">&#39;AS&#39;</span><span class="p">,</span> <span class="s1">&#39;MC&#39;</span><span class="p">,</span> <span class="s1">&#39;DS&#39;</span><span class="p">,</span> <span class="s1">&#39;IC&#39;</span><span class="p">],</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">seq</span><span class="p">).</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span>
              <span class="nv">angled = </span><span class="kc">true</span>
            <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">idx</span> <span class="k">of</span> <span class="nx">seq</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Makes any house extra.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">out</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">extra = </span><span class="kc">true</span> <span class="k">if</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;H&#39;</span> <span class="o">and</span> <span class="nx">angled</span> <span class="o">is</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Topical &amp; Fortune Houses.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="k">if</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;T&#39;</span> <span class="o">or</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">is</span> <span class="s1">&#39;F&#39;</span>
                <span class="nx">out</span><span class="p">[</span><span class="nx">idx</span><span class="p">].</span><span class="nv">extra = </span><span class="kc">true</span>
                <span class="k">switch</span> <span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="k">when</span> <span class="s1">&#39;T&#39;</span> <span class="k">then</span> <span class="nv">topical = </span><span class="nx">id</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">1</span>
                  <span class="k">when</span> <span class="s1">&#39;F&#39;</span> <span class="k">then</span> <span class="nv">fortune = </span><span class="nx">id</span><span class="p">.</span><span class="nx">substr</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="nx">topical</span> <span class="o">isnt</span> <span class="kc">false</span>
              <span class="nx">out</span><span class="p">[</span><span class="nx">i_mark</span><span class="p">].</span><span class="nx">what</span> <span class="o">+=</span> <span class="s2">&quot; #{topical}&quot;</span><span class="p">.</span><span class="nx">white</span>
              <span class="k">if</span> <span class="nx">fortune</span> <span class="o">isnt</span> <span class="kc">false</span>
                <span class="nx">out</span><span class="p">[</span><span class="nx">i_mark</span><span class="p">].</span><span class="nx">what</span> <span class="o">+=</span> <span class="s2">&quot; / #{fortune}&quot;</span><span class="p">.</span><span class="nx">white</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Reset the sequence after a longitude change is processed.</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">seq = </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>From here on, there is always at least one one id in the sequence.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">seq</span><span class="p">[</span><span class="s2">&quot;#{item.id}&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>It's mportant to set the marker index after processing.
Otherwise, sometimes the next marker steals the topics.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">i_mark = </span><span class="nx">i</span> <span class="k">if</span> <span class="nx">item</span><span class="p">.</span><span class="nx">marker</span> <span class="o">is</span> <span class="kc">true</span>
        <span class="nv">prev = </span><span class="nx">item</span>
      <span class="nv">outer = </span><span class="nx">_</span><span class="p">.</span><span class="nx">filter</span> <span class="nx">out</span><span class="p">,</span> <span class="nf">(final) -&gt;</span> <span class="nx">final</span><span class="p">.</span><span class="nx">extra</span> <span class="o">is</span> <span class="kc">false</span>
      <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span> <span class="nx">cliff</span><span class="p">.</span><span class="nx">stringifyObjectRows</span> <span class="nx">outer</span><span class="p">,</span> <span class="nx">titles</span><span class="p">,</span> <span class="nx">color</span>

    <span class="k">else</span> <span class="nx">stream</span><span class="p">.</span><span class="nx">write</span> <span class="s2">&quot;Given no data.&quot;</span>

    <span class="nx">stream</span><span class="p">.</span><span class="nx">emit</span> <span class="s2">&quot;end&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 